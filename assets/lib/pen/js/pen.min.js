!function(e,t){function n(e,n,i){var r=" to exec 「"+n+"」 command"+(i?" with value: "+i:"");try{t.execCommand(n,!1,i)}catch(e){return O.log("fail"+r,!0)}O.log("success"+r)}function i(e,t,i){var r=E(e);if(r)return e._range.selectNode(r),e._range.collapse(!1),"insertimage"===t&&e._menu&&M(e._menu,!0),n(e,t,i)}function r(e,t){return-1!==w(e,!0).indexOf(t)&&(t="p"),n(e,"formatblock",t)}function o(e,t,i){return i="<"+t+">"+(i||q.toString())+"</"+t+">",n(e,"insertHTML",i)}function a(e,t,i){return e.config.linksInNewWindow?(i='<a href="'+i+'" target="_blank">'+q.toString()+"</a>",n(e,"insertHTML",i)):n(e,t,i)}function c(e,t,n,i){var r=e.config.titles[t]||"",o=document.createElement("div");o.classList.add("pen-icon"),o.setAttribute("title",r),"parent"===n?(o.classList.add("pen-group-icon"),o.setAttribute("data-group-toggle",t)):o.setAttribute("data-action",t),"child"===n&&o.setAttribute("data-group",i);var a=e.config.toolbarIconsDictionary[t];if(a&&a.text)o.textContent=a.text;else{var c;c=a&&a.className?a.className:e.config.toolbarIconsPrefix+t,o.innerHTML+='<i class="'+c+'"  ></i>'}return o.outerHTML}function s(e){return Array.prototype.slice.call(e._menu.children)}function l(e,t){s(e).forEach(function(e){M(e,e.getAttribute("data-group")!==t)}),d(e,!t),e.refreshMenuPosition()}function u(e){l(e,null),f(e,!0)}function h(e){s(e).forEach(function(e){M(e,!0)}),f(e),d(e)}function f(e,t){var n=e._menu.querySelector(".pen-input-wrapper");n&&(M(n,t),e.refreshMenuPosition())}function d(e,t){M(e._menu.querySelector('[data-action="close"]'),t),e.refreshMenuPosition()}function p(){var e=t.createElement("div"),n=t.createElement("input"),i=t.createElement("label"),r=t.createElement("input"),o=t.createElement("i");return e.className="pen-input-wrapper",n.className="pen-url-input",n.type="url",n.placeholder="http://",i.className="pen-icon pen-input-label",r.className="pen-external-url-checkbox",r.type="checkbox",o.className="eicon-external-link",i.appendChild(r),i.appendChild(o),e.appendChild(n),e.appendChild(i),e}function g(e){var n="",i=p().outerHTML;if(e._toolbar=e.config.toolbar,e._toolbar)(e._toolbar.querySelectorAll("[data-action=createlink]").length||e._toolbar.querySelectorAll("[data-action=insertimage]").length)&&(n+=i);else{var r=e.config.list;O.forEach(r,function(t,i){if(Array.isArray(t)){var r=t;n+=c(e,t=i,"parent"),O.forEach(r,function(i){n+=c(e,i,"child",t)},!0)}else n+=c(e,t)});var o=Object.values(r);(o.indexOf("createlink")>=0||o.indexOf("insertimage")>=0)&&(n+=i),n+=c(e,"close")}n&&(e._menu=t.createElement("div"),e._menu.setAttribute("class",e.config.class+"-menu pen-menu"),e._menu.innerHTML=n,e._urlInput=e._menu.querySelector(".pen-url-input"),e._externalUrlCheckbox=e._menu.querySelector(".pen-external-url-checkbox"),M(e._menu,!0),t.body.appendChild(e._menu))}function m(n){function i(e){n._range=n.getRange(),a(e)}var r=n._toolbar||n._menu,o=n.config.editor,a=O.delayExec(function(){n.highlight().menu()}),c=function(){};if(n._menu){var s=function(){"flex"===n._menu.style.display&&n.menu()};v(n,e,"resize",s),v(n,e,"scroll",s);var f=!1;v(n,o,"mousedown",function(){f=!0}),v(n,o,"mouseleave",function(){f&&i(800),f=!1}),v(n,o,"mouseup",function(){f&&i(100),f=!1}),c=function(e){!n._menu||x(o,e.target)||x(n._menu,e.target)||(b(n,t,"click",c),a(100))}}else v(n,o,"click",function(){i(0)});v(n,o,"keyup",function(e){if(8===e.which&&n.isEmpty())return L(n,!0);if(13!==e.which||e.shiftKey)return i(400);var r=E(n,!0);r&&r.nextSibling&&D.test(r.nodeName)&&r.nodeName===r.nextSibling.nodeName&&("BR"!==r.lastChild.nodeName&&r.appendChild(t.createElement("br")),O.forEach(r.nextSibling.childNodes,function(e){e&&r.appendChild(e)},!0),r.parentNode.removeChild(r.nextSibling),A(n,r.lastChild,n.getRange()))}),v(n,o,"keydown",function(e){if(o.classList.remove("pen-placeholder"),13===e.which&&!e.shiftKey){var i=E(n,!0);if(i&&D.test(i.nodeName)){var r=i.lastChild;if(r&&r.previousSibling&&!r.previousSibling.textContent&&!r.textContent){e.preventDefault();var a=t.createElement("p");a.innerHTML="<br>",i.removeChild(r),i.nextSibling?i.parentNode.insertBefore(a,i.nextSibling):i.parentNode.appendChild(a),A(n,a,n.getRange())}}}});var d=function(e,t){n.execCommand(e,t),n._range=n.getRange(),n.highlight().menu()};v(n,r,"click",function(e){for(var t,i=e.target;!(t=i.getAttribute("data-action"))&&i.parentNode!==r;)i=i.parentNode;var o=i.getAttribute("data-group-toggle");if(o&&l(n,o),t)if("close"!==t){if(!/(?:createlink)|(?:insertimage)/.test(t))return d(t);if(n._urlInput){var a=n._urlInput;if(r===n._menu?h(n):(n._inputActive=!0,n.menu()),"none"!==n._menu.style.display){setTimeout(function(){a.focus()},100);var c=function(){var e=a.value;e?(n.config.linksInNewWindow=n._externalUrlCheckbox.checked,e=a.value.replace(j.whiteSpace,"").replace(j.mailTo,"mailto:$1").replace(j.http,"http://$1")):t="unlink",d(t,e)};a.onkeypress=function(e){13===e.which&&(e.preventDefault(),c())},n._externalUrlCheckbox.onchange=c}}}else u(n)}),v(n,o,"focus",function(){n.isEmpty()&&L(n,!0),v(n,t,"click",c)}),v(n,o,"blur",function(){C(n),n.checkContentChange()}),v(n,o,"paste",function(){setTimeout(function(){n.cleanContent()})})}function v(e,t,n,i){if(e._events.hasOwnProperty(n))e._events[n].push(i);else{e._eventTargets=e._eventTargets||[],e._eventsCache=e._eventsCache||[];var r=e._eventTargets.indexOf(t);r<0&&(r=e._eventTargets.push(t)-1),e._eventsCache[r]=e._eventsCache[r]||{},e._eventsCache[r][n]=e._eventsCache[r][n]||[],e._eventsCache[r][n].push(i),t.addEventListener(n,i,!1)}return e}function y(e,t){if(e._events.hasOwnProperty(t)){var n=I.call(arguments,2);O.forEach(e._events[t],function(t){t.apply(e,n)})}}function b(e,t,n,i){var r=e._events[n];if(!r){var o=e._eventTargets.indexOf(t);o>=0&&(r=e._eventsCache[o][n])}if(!r)return e;var a=r.indexOf(i);return a>=0&&r.splice(a,1),t.removeEventListener(n,i,!1),e}function _(e){return O.forEach(this._events,function(e){e.length=0},!1),e._eventsCache?(O.forEach(e._eventsCache,function(t,n){var i=e._eventTargets[n];O.forEach(t,function(e,t){O.forEach(e,function(e){i.removeEventListener(t,e,!1)},!0)},!1)},!0),e._eventTargets=[],e._eventsCache=[],e):e}function C(e){e.config.editor.classList[e.isEmpty()?"add":"remove"]("pen-placeholder")}function k(e){return(e||"").replace(/^\s+|\s+$/g,"")}function x(e,t){if(e===t)return!0;for(t=t.parentNode;t;){if(t===e)return!0;t=t.parentNode}return!1}function E(e,t){var n,i=e.config.editor;if(e._range=e._range||e.getRange(),!(n=e._range.commonAncestorContainer)||n===i)return null;for(;n&&1!==n.nodeType&&n.parentNode!==i;)n=n.parentNode;for(;n&&t&&n.parentNode!==i;)n=n.parentNode;return x(i,n)?n:null}function w(e,t){return N(e,t).filter(function(e){return e.nodeName.match(U)})}function N(e,t){for(var n=[],i=E(e);i&&i!==e.config.editor;)i.nodeType===Node.ELEMENT_NODE&&n.push(t?i.nodeName.toLowerCase():i),i=i.parentNode;return n}function L(e,n){var i=e._range=e.getRange(),r=t.createElement("p");n&&(e.config.editor.innerHTML=""),r.innerHTML="<br>",i.insertNode(r),A(e,r.childNodes[0],i)}function A(e,t,n){n.setStartAfter(t),n.setEndBefore(t),n.collapse(!1),e.setRange(n)}function T(e){if(1===e.nodeType){if(B.notLink.test(e.tagName))return;O.forEach(e.childNodes,function(e){T(e)},!0)}else if(3===e.nodeType){var n=S(e.nodeValue||"");if(!n.links)return;var i=t.createDocumentFragment(),r=t.createElement("div");for(r.innerHTML=n.text;r.childNodes.length;)i.appendChild(r.childNodes[0]);e.parentNode.replaceChild(i,e)}}function S(e){var t=0;return e=e.replace(B.url,function(e){var n=e,i=e;return t++,e.length>B.maxLength&&(i=e.slice(0,B.maxLength)+"..."),B.prefix.test(n)||(n="http://"+n),'<a href="'+n+'">'+i+"</a>"}),{links:t,text:e}}function M(e,t){e.style.display=t?"none":"flex"}var $,R,q,O={},H=Object.prototype.toString,I=Array.prototype.slice,P={block:/^(?:p|h[1-6]|blockquote|pre)$/,inline:/^(?:justify(center|full|left|right)|strikethrough|bold|italic|underline|insert(un)?orderedlist|(in|out)dent)$/,source:/^(?:createlink|unlink)$/,insert:/^(?:inserthorizontalrule|insertimage|insert)$/,wrap:/^(?:code)$/},D=/^(?:blockquote|pre|div)$/i,U=/(?:[pubia]|h[1-6]|blockquote|code|[uo]l|li)/i,j={whiteSpace:/(^\s+)|(\s+$)/g,mailTo:/^(?!mailto:|.+\/|.+#|.+\?)(.*@.*\..+)$/,http:/^(?!\w+?:\/\/|mailto:|\/|\.\/|\?|#)(.*)$/},B={url:/((https?|ftp):\/\/|www\.)[^\s<]{3,}/gi,prefix:/^(?:https?|ftp):\/\//i,notLink:/^(?:img|a|input|audio|video|source|code|pre|script|head|title|style)$/i,maxLength:100};O.is=function(e,t){return H.call(e).slice(8,-1)===t},O.forEach=function(e,t,n){if(e)if(null==n&&(n=O.is(e,"Array")),n)for(var i=0,r=e.length;i<r;i++)t(e[i],i,e);else for(var o in e)e.hasOwnProperty(o)&&t(e[o],o,e)},O.copy=function(e,t){return O.forEach(t,function(t,n){e[n]=O.is(t,"Object")?O.copy({},t):O.is(t,"Array")?O.copy([],t):t}),e},O.log=function(e,t){(R||t)&&console.log("%cPEN DEBUGGER: %c"+e,"font-family:arial,sans-serif;color:#1abf89;line-height:2em;","font-family:cursor,monospace;color:#333;")},O.delayExec=function(e){var t=null;return function(n){clearTimeout(t),t=setTimeout(function(){e()},n||1)}},O.merge=function(e){var n={class:"pen",debug:!1,toolbar:null,toolbarIconsPrefix:"fa fa-",toolbarIconsDictionary:{},stay:e.stay||!e.debug,stayMsg:"Are you going to leave here?",textarea:'<textarea name="content"></textarea>',list:["blockquote","h2","h3","p","code","insertOrderedList","insertUnorderedList","inserthorizontalrule","indent","outdent","bold","italic","underline","createlink","insertimage"],titles:{},cleanAttrs:["id","class","style","name"],cleanTags:["script"],linksInNewWindow:!1};return 1===e.nodeType?n.editor=e:e.match&&e.match(/^#[\S]+$/)?n.editor=t.getElementById(e.slice(1)):n=O.copy(n,e),n},($=function(e){if(!e)throw new Error("Can't find config");R=e.debug;var t=O.merge(e),n=t.editor;if(!n||1!==n.nodeType)throw new Error("Can't find editor");n.classList.add(t.class),n.setAttribute("contenteditable","true"),this.config=t,t.placeholder&&n.setAttribute("data-placeholder",t.placeholder),C(this),this.selection=q,this._events={change:[]},g(this),m(this),this._prevContent=this.getContent(),this.markdown&&this.markdown.init(this),this.config.stay&&this.stay(this.config),this.config.input&&this.addOnSubmitListener(this.config.input)}).prototype.on=function(e,t){return v(this,this.config.editor,e,t),this},$.prototype.addOnSubmitListener=function(e){var t=this;e.form.addEventListener("submit",function(){e.value=t.config.saveAsMarkdown?t.toMd(t.config.editor.innerHTML):t.config.editor.innerHTML})},$.prototype.isEmpty=function(e){return!((e=e||this.config.editor).querySelector("img")||e.querySelector("blockquote")||e.querySelector("li")||k(e.textContent))},$.prototype.getContent=function(){return this.isEmpty()?"":k(this.config.editor.innerHTML)},$.prototype.setContent=function(e){return this.config.editor.innerHTML=e,this.cleanContent(),this},$.prototype.checkContentChange=function(){var e=this._prevContent,t=this.getContent();e!==t&&(this._prevContent=t,y(this,"change",t,e))},$.prototype.getRange=function(){var e=this.config.editor,n=q.rangeCount&&q.getRangeAt(0);return n||(n=t.createRange()),x(e,n.commonAncestorContainer)||(n.selectNodeContents(e),n.collapse(!1)),n},$.prototype.setRange=function(e){(e=e||this._range)||(e=this.getRange()).collapse(!1);try{q.removeAllRanges(),q.addRange(e)}catch(e){}return this},$.prototype.focus=function(e){return e||this.setRange(),this.config.editor.focus(),this},$.prototype.execCommand=function(e,t){e=e.toLowerCase(),this.setRange(),P.block.test(e)?r(this,e):P.inline.test(e)?n(this,e,t):P.source.test(e)?a(this,e,t):P.insert.test(e)?i(this,e,t):P.wrap.test(e)?o(this,e,t):O.log("can not find command function for name: "+e+(t?", value: "+t:""),!0),"indent"===e&&this.checkContentChange()},$.prototype.cleanContent=function(e){var t=this.config.editor;return e||(e=this.config),O.forEach(e.cleanAttrs,function(e){O.forEach(t.querySelectorAll("["+e+"]"),function(t){t.removeAttribute(e)},!0)},!0),O.forEach(e.cleanTags,function(e){O.forEach(t.querySelectorAll(e),function(e){e.parentNode.removeChild(e)},!0)},!0),C(this),this.checkContentChange(),this},$.prototype.autoLink=function(){return T(this.config.editor),this.getContent()},$.prototype.highlight=function(){var e=this._toolbar||this._menu,t=E(this);if(O.forEach(e.querySelectorAll(".active"),function(e){e.classList.remove("active")},!0),!t)return this;var n,i=N(this),r=this._urlInput,o=this._externalUrlCheckbox;return r&&e===this._menu&&(r.value="",this._externalUrlCheckbox.checked=!1),n=function(t){if(t){var n=e.querySelector("[data-action="+t+"]");return n&&n.classList.add("active")}},O.forEach(i,function(e){var t=e.nodeName.toLowerCase(),i=e.style.textAlign;if(i&&("justify"===i&&(i="full"),n("justify"+i[0].toUpperCase()+i.slice(1))),t.match(U)){switch(t){case"a":r.value=e.getAttribute("href"),o.checked="_blank"===e.getAttribute("target"),t="createlink";break;case"img":r.value=e.getAttribute("src"),t="insertimage";break;case"i":t="italic";break;case"u":t="underline";break;case"b":t="bold";break;case"strike":t="strikethrough";break;case"pre":case"code":t="code";break;case"ul":t="insertUnorderedList";break;case"ol":t="insertOrderedList";break;case"li":t="indent"}n(t)}},!0),this},$.prototype.menu=function(){return this._menu?q.isCollapsed?(this._menu.style.display="none",this._inputActive=!1,this):!this._toolbar||this._urlInput&&this._inputActive?void u(this):this:this},$.prototype.refreshMenuPosition=function(){var e=this._range.getBoundingClientRect(),t=e.top-10,n=e.left+e.width/2,i=this._menu,r={x:0,y:0},o=this._stylesheet;if(0===e.width&&0===e.height)return this;if(void 0===this._stylesheet){var a=document.createElement("style");document.head.appendChild(a),this._stylesheet=o=a.sheet}return i.style.display="flex",r.x=n-i.clientWidth/2,r.y=t-i.clientHeight,o.cssRules.length>0&&o.deleteRule(0),r.x<0?(r.x=0,o.insertRule(".pen-menu:after {left: "+n+"px;}",0)):o.insertRule(".pen-menu:after {left: 50%; }",0),r.y<0?(i.classList.add("pen-menu-below"),r.y=e.top+e.height+10):i.classList.remove("pen-menu-below"),i.style.top=r.y+"px",i.style.left=r.x+"px",this},$.prototype.stay=function(e){var t=this;window.onbeforeunload||(window.onbeforeunload=function(){if(!t._isDestroyed)return e.stayMsg})},$.prototype.destroy=function(e){var t=!e,n=e?"setAttribute":"removeAttribute";if(e)g(this),m(this);else{_(this);try{q.removeAllRanges(),this._menu&&this._menu.parentNode.removeChild(this._menu)}catch(e){}}return this._isDestroyed=t,this.config.editor[n]("contenteditable",""),this},$.prototype.rebuild=function(){return this.destroy("it's a joke")},e.Pen=function(e){if(!e)return O.log("can't find config",!0);var t=O.merge(e),n=t.editor.getAttribute("class");return n=n?n.replace(/\bpen\b/g,"")+" pen-textarea "+t.class:"pen pen-textarea",t.editor.setAttribute("class",n),t.editor.innerHTML=t.textarea,t.editor};var W={a:[/<a\b[^>]*href=["']([^"]+|[^']+)\b[^>]*>(.*?)<\/a>/gi,"[$2]($1)"],img:[/<img\b[^>]*src=["']([^\"+|[^']+)[^>]*>/gi,"![]($1)"],b:[/<b\b[^>]*>(.*?)<\/b>/gi,"**$1**"],i:[/<i\b[^>]*>(.*?)<\/i>/gi,"***$1***"],h:[/<h([1-6])\b[^>]*>(.*?)<\/h\1>/gi,function(e,t,n){return"\n"+"######".slice(0,t)+" "+n+"\n"}],li:[/<(li)\b[^>]*>(.*?)<\/\1>/gi,"* $2\n"],blockquote:[/<(blockquote)\b[^>]*>(.*?)<\/\1>/gi,"\n> $2\n"],pre:[/<pre\b[^>]*>(.*?)<\/pre>/gi,"\n```\n$1\n```\n"],code:[/<code\b[^>]*>(.*?)<\/code>/gi,"\n`\n$1\n`\n"],p:[/<p\b[^>]*>(.*?)<\/p>/gi,"\n$1\n"],hr:[/<hr\b[^>]*>/gi,"\n---\n"]};$.prototype.toMd=function(){var e=this.getContent().replace(/\n+/g,"").replace(/<([uo])l\b[^>]*>(.*?)<\/\1l>/gi,"$2");for(var t in W)W.hasOwnProperty(t)&&(e=e.replace.apply(e,W[t]));return e.replace(/\*{5}/g,"**")},t.getSelection&&(q=t.getSelection(),e.Pen=$)}(window,document);