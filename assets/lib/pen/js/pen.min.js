!function(e,t){function n(e,n,i){var r=" to exec 「"+n+"」 command"+(i?" with value: "+i:"");try{t.execCommand(n,!1,i)}catch(e){return I.log("fail"+r,!0)}I.log("success"+r)}function i(e,t,i){var r=N(e);if(r)return e._range.selectNode(r),e._range.collapse(!1),"insertimage"===t&&e._menu&&R(e._menu,!0),n(e,t,i)}function r(e,t){return-1!==L(e).map(function(e){return e.nodeName.toLowerCase()}).indexOf(t)&&(t="p"),n(e,"formatblock",t)}function o(e,t,i){return i="<"+t+">"+(i||H.toString())+"</"+t+">",n(e,"insertHTML",i)}function a(e,t,i){return e.config.linksInNewWindow?(i='<a href="'+i+'" target="_blank">'+H.toString()+"</a>",n(e,"insertHTML",i)):n(e,t,i)}function c(e,t,n,i){var r=e.config.titles[t]||"",o=document.createElement("div");o.classList.add("pen-icon"),o.setAttribute("title",r),"parent"===n?(o.classList.add("pen-group-icon"),o.setAttribute("data-group-toggle",t)):o.setAttribute("data-action",t),"child"===n&&o.setAttribute("data-group",i);var a=e.config.toolbarIconsDictionary[t];if(a&&a.text)o.textContent=a.text;else{var c;c=a&&a.className?a.className:e.config.toolbarIconsPrefix+t,o.innerHTML+='<i class="'+c+'"  ></i>'}return o.outerHTML}function s(e){return D.call(e._menu.children)}function l(e,t){s(e).forEach(function(e){R(e,e.getAttribute("data-group")!==t)}),d(e,!t),e.refreshMenuPosition()}function u(e){l(e,null),h(e,!0)}function f(e){s(e).forEach(function(e){R(e,!0)}),h(e),d(e)}function h(e,t){var n=e._menu.querySelector(".pen-input-wrapper");n&&(R(n,t),e.refreshMenuPosition())}function d(e,t){R(e._menu.querySelector('[data-action="close"]'),t),e.refreshMenuPosition()}function p(e){var n=t.createElement("div"),i=t.createElement("input"),r=t.createElement("label"),o=t.createElement("input"),a=t.createElement("i");return n.className="pen-input-wrapper",i.className="pen-url-input",i.type="url",i.placeholder="http://",r.className="pen-icon pen-input-label",o.className="pen-external-url-checkbox",o.type="checkbox",a.className=e.config.toolbarIconsDictionary.externalLink.className,r.appendChild(o),r.appendChild(a),n.appendChild(i),n.appendChild(r),n}function g(e,t,n){e.execCommand(t,n),e._range=e.getRange(),e.highlight().menu()}function m(e,t){for(var n,i=e._toolbar||e._menu;!(n=t.getAttribute("data-action"))&&t.parentNode!==i;)t=t.parentNode;var r=t.getAttribute("data-group-toggle");if(r&&l(e,r),n)if("close"!==n){if(!/(?:createlink)|(?:insertimage)/.test(n))return g(e,n);if(e._urlInput){var o=e._urlInput;if(i===e._menu?f(e):(e._inputActive=!0,e.menu()),"none"!==e._menu.style.display){setTimeout(function(){o.focus()},100);var a=function(){var t=o.value;t?(e.config.linksInNewWindow=e._externalUrlCheckbox.checked,t=o.value.replace(W.whiteSpace,"").replace(W.mailTo,"mailto:$1").replace(W.http,"http://$1")):n="unlink",g(e,n,t)};o.onkeypress=function(e){13===e.which&&(e.preventDefault(),a())},e._externalUrlCheckbox.onchange=a}}}else u(e)}function v(e){var n="",i=p(e).outerHTML;if(e._toolbar=e.config.toolbar,e._toolbar)(e._toolbar.querySelectorAll("[data-action=createlink]").length||e._toolbar.querySelectorAll("[data-action=insertimage]").length)&&(n+=i);else{var r=e.config.list;if(!Object.values(r).length)return;I.forEach(r,function(t,i){if(Array.isArray(t)){var r=t;n+=c(e,t=i,"parent"),I.forEach(r,function(i){n+=c(e,i,"child",t)},!0)}else n+=c(e,t)});var o=Object.values(r);(o.indexOf("createlink")>=0||o.indexOf("insertimage")>=0)&&(n+=i),n+=c(e,"close")}n&&(e._menu=t.createElement("div"),e._menu.setAttribute("class",e.config.class+"-menu pen-menu"),e._menu.innerHTML=n,e._urlInput=e._menu.querySelector(".pen-url-input"),e._externalUrlCheckbox=e._menu.querySelector(".pen-external-url-checkbox"),R(e._menu,!0),t.body.appendChild(e._menu))}function b(n){function i(e){n._range=n.getRange(),a(e)}var r=n._toolbar||n._menu,o=n.config.editor,a=I.delayExec(function(){r&&n.highlight().menu()}),c=function(){};if(n._menu){var s=function(){"flex"===n._menu.style.display&&n.menu()};y(n,e,"resize",s),y(n,e,"scroll",s);var l=!1;y(n,o,"mousedown",function(){l=!0}),y(n,o,"mouseleave",function(){l&&i(800),l=!1}),y(n,o,"mouseup",function(){l&&i(100),l=!1}),c=function(e){!n._menu||w(o,e.target)||w(n._menu,e.target)||(C(n,t,"click",c),a(100))}}else y(n,o,"click",function(){i(0)});y(n,o,"keyup",function(e){if(8===e.which&&n.isEmpty())return T(n,!0);if(13!==e.which||e.shiftKey)return i(400);var r=N(n,!0);r&&r.nextSibling&&j.test(r.nodeName)&&r.nodeName===r.nextSibling.nodeName&&("BR"!==r.lastChild.nodeName&&r.appendChild(t.createElement("br")),I.forEach(r.nextSibling.childNodes,function(e){e&&r.appendChild(e)},!0),r.parentNode.removeChild(r.nextSibling),S(n,r.lastChild,n.getRange()))}),y(n,o,"keydown",function(e){if(o.classList.remove("pen-placeholder"),13===e.which&&!e.shiftKey){var i=N(n,!0);if(i&&j.test(i.nodeName)){var r=i.lastChild;if(r&&r.previousSibling&&!r.previousSibling.textContent&&!r.textContent){e.preventDefault();var a=t.createElement("p");a.innerHTML="<br>",i.removeChild(r),i.nextSibling?i.parentNode.insertBefore(a,i.nextSibling):i.parentNode.appendChild(a),S(n,a,n.getRange())}}}}),r&&y(n,r,"click",function(e){m(n,e.target)}),y(n,o,"focus",function(){n.isEmpty()&&T(n,!0),y(n,t,"click",c)}),y(n,o,"blur",function(){x(n),n.checkContentChange()}),y(n,o,"paste",function(){setTimeout(function(){n.cleanContent()})})}function y(e,t,n,i){if(e._events.hasOwnProperty(n))e._events[n].push(i);else{e._eventTargets=e._eventTargets||[],e._eventsCache=e._eventsCache||[];var r=e._eventTargets.indexOf(t);r<0&&(r=e._eventTargets.push(t)-1),e._eventsCache[r]=e._eventsCache[r]||{},e._eventsCache[r][n]=e._eventsCache[r][n]||[],e._eventsCache[r][n].push(i),t.addEventListener(n,i,!1)}return e}function _(e,t){if(e._events.hasOwnProperty(t)){var n=D.call(arguments,2);I.forEach(e._events[t],function(t){t.apply(e,n)})}}function C(e,t,n,i){var r=e._events[n];if(!r){var o=e._eventTargets.indexOf(t);o>=0&&(r=e._eventsCache[o][n])}if(!r)return e;var a=r.indexOf(i);return a>=0&&r.splice(a,1),t.removeEventListener(n,i,!1),e}function k(e){return I.forEach(this._events,function(e){e.length=0},!1),e._eventsCache?(I.forEach(e._eventsCache,function(t,n){var i=e._eventTargets[n];I.forEach(t,function(e,t){I.forEach(e,function(e){i.removeEventListener(t,e,!1)},!0)},!1)},!0),e._eventTargets=[],e._eventsCache=[],e):e}function x(e){e.config.editor.classList[e.isEmpty()?"add":"remove"]("pen-placeholder")}function E(e){return(e||"").replace(/^\s+|\s+$/g,"")}function w(e,t){if(e===t)return!0;for(t=t.parentNode;t;){if(t===e)return!0;t=t.parentNode}return!1}function N(e,t){var n,i=e.config.editor;if(e._range=e._range||e.getRange(),!(n=e._range.commonAncestorContainer)||n===i)return null;for(;n&&1!==n.nodeType&&n.parentNode!==i;)n=n.parentNode;for(;n&&t&&n.parentNode!==i;)n=n.parentNode;return w(i,n)?n:null}function L(e){return A(e).filter(function(e){return e.nodeName.match(B)})}function A(e){for(var t=[],n=N(e);n&&n!==e.config.editor;)n.nodeType===Node.ELEMENT_NODE&&t.push(n),n=n.parentNode;return t}function T(e,n){var i=e._range=e.getRange(),r=t.createElement("p");n&&(e.config.editor.innerHTML=""),r.innerHTML="<br>",i.insertNode(r),S(e,r.childNodes[0],i)}function S(e,t,n){n.setStartAfter(t),n.setEndBefore(t),n.collapse(!1),e.setRange(n)}function M(e){if(1===e.nodeType){if(z.notLink.test(e.tagName))return;I.forEach(e.childNodes,function(e){M(e)},!0)}else if(3===e.nodeType){var n=$(e.nodeValue||"");if(!n.links)return;var i=t.createDocumentFragment(),r=t.createElement("div");for(r.innerHTML=n.text;r.childNodes.length;)i.appendChild(r.childNodes[0]);e.parentNode.replaceChild(i,e)}}function $(e){var t=0;return e=e.replace(z.url,function(e){var n=e,i=e;return t++,e.length>z.maxLength&&(i=e.slice(0,z.maxLength)+"..."),z.prefix.test(n)||(n="http://"+n),'<a href="'+n+'">'+i+"</a>"}),{links:t,text:e}}function R(e,t){e.style.display=t?"none":"flex"}var q,O,H,I={},P=Object.prototype.toString,D=Array.prototype.slice,U={block:/^(?:p|h[1-6]|blockquote|pre)$/,inline:/^(?:justify(center|full|left|right)|strikethrough|bold|italic|underline|insert(un)?orderedlist|(in|out)dent)$/,source:/^(?:createlink|unlink)$/,insert:/^(?:inserthorizontalrule|insertimage|insert)$/,wrap:/^(?:code)$/},j=/^(?:blockquote|pre|div)$/i,B=/(?:[pubia]|h[1-6]|blockquote|code|[uo]l|li)/i,W={whiteSpace:/(^\s+)|(\s+$)/g,mailTo:/^(?!mailto:|.+\/|.+#|.+\?)(.*@.*\..+)$/,http:/^(?!\w+?:\/\/|mailto:|\/|\.\/|\?|#)(.*)$/},z={url:/((https?|ftp):\/\/|www\.)[^\s<]{3,}/gi,prefix:/^(?:https?|ftp):\/\//i,notLink:/^(?:img|a|input|audio|video|source|code|pre|script|head|title|style)$/i,maxLength:100};I.is=function(e,t){return P.call(e).slice(8,-1)===t},I.forEach=function(e,t,n){if(e)if(null==n&&(n=I.is(e,"Array")),n)for(var i=0,r=e.length;i<r;i++)t(e[i],i,e);else for(var o in e)e.hasOwnProperty(o)&&t(e[o],o,e)},I.copy=function(e,t){return I.forEach(t,function(t,n){e[n]=I.is(t,"Object")?I.copy({},t):I.is(t,"Array")?I.copy([],t):t}),e},I.log=function(e,t){(O||t)&&console.log("%cPEN DEBUGGER: %c"+e,"font-family:arial,sans-serif;color:#1abf89;line-height:2em;","font-family:cursor,monospace;color:#333;")},I.delayExec=function(e){var t=null;return function(n){clearTimeout(t),t=setTimeout(function(){e()},n||1)}},I.merge=function(e){var n={class:"pen",debug:!1,toolbar:null,toolbarIconsPrefix:"fa fa-",toolbarIconsDictionary:{externalLink:"fa fa-external-link"},stay:e.stay||!e.debug,stayMsg:"Are you going to leave here?",textarea:'<textarea name="content"></textarea>',list:["blockquote","h2","h3","p","code","insertOrderedList","insertUnorderedList","inserthorizontalrule","indent","outdent","bold","italic","underline","createlink","insertimage"],titles:{},cleanAttrs:["id","class","style","name"],cleanTags:["script"],linksInNewWindow:!1};return 1===e.nodeType?n.editor=e:e.match&&e.match(/^#[\S]+$/)?n.editor=t.getElementById(e.slice(1)):n=I.copy(n,e),n},(q=function(e){if(!e)throw new Error("Can't find config");O=e.debug;var t=I.merge(e),n=t.editor;if(!n||1!==n.nodeType)throw new Error("Can't find editor");n.classList.add(t.class),n.setAttribute("contenteditable","true"),this.config=t,t.placeholder&&n.setAttribute("data-placeholder",t.placeholder),x(this),this.selection=H,this._events={change:[]},v(this),b(this),this._prevContent=this.getContent(),this.markdown&&this.markdown.init(this),this.config.stay&&this.stay(this.config),this.config.input&&this.addOnSubmitListener(this.config.input)}).prototype.on=function(e,t){return y(this,this.config.editor,e,t),this},q.prototype.addOnSubmitListener=function(e){var t=this;e.form.addEventListener("submit",function(){e.value=t.config.saveAsMarkdown?t.toMd(t.config.editor.innerHTML):t.config.editor.innerHTML})},q.prototype.isEmpty=function(e){return!((e=e||this.config.editor).querySelector("img")||e.querySelector("blockquote")||e.querySelector("li")||E(e.textContent))},q.prototype.getContent=function(){return this.isEmpty()?"":E(this.config.editor.innerHTML)},q.prototype.setContent=function(e){return this.config.editor.innerHTML=e,this.cleanContent(),this},q.prototype.checkContentChange=function(){var e=this._prevContent,t=this.getContent();e!==t&&(this._prevContent=t,_(this,"change",t,e))},q.prototype.getRange=function(){var e=this.config.editor,n=H.rangeCount&&H.getRangeAt(0);return n||(n=t.createRange()),w(e,n.commonAncestorContainer)||(n.selectNodeContents(e),n.collapse(!1)),n},q.prototype.setRange=function(e){(e=e||this._range)||(e=this.getRange()).collapse(!1);try{H.removeAllRanges(),H.addRange(e)}catch(e){}return this},q.prototype.focus=function(e){return e||this.setRange(),this.config.editor.focus(),this},q.prototype.execCommand=function(e,t){e=e.toLowerCase(),this.setRange(),U.block.test(e)?r(this,e):U.inline.test(e)?n(this,e,t):U.source.test(e)?a(this,e,t):U.insert.test(e)?i(this,e,t):U.wrap.test(e)?o(this,e,t):I.log("can not find command function for name: "+e+(t?", value: "+t:""),!0),"indent"===e&&this.checkContentChange()},q.prototype.cleanContent=function(e){var t=this.config.editor;return e||(e=this.config),I.forEach(e.cleanAttrs,function(e){I.forEach(t.querySelectorAll("["+e+"]"),function(t){t.removeAttribute(e)},!0)},!0),I.forEach(e.cleanTags,function(e){I.forEach(t.querySelectorAll(e),function(e){e.parentNode.removeChild(e)},!0)},!0),x(this),this.checkContentChange(),this},q.prototype.autoLink=function(){return M(this.config.editor),this.getContent()},q.prototype.highlight=function(){var e=this._toolbar||this._menu,t=N(this);if(I.forEach(e.querySelectorAll(".active"),function(e){e.classList.remove("active")},!0),!t)return this;var n,i=A(this),r=this._urlInput,o=this._externalUrlCheckbox;return r&&e===this._menu&&(r.value="",this._externalUrlCheckbox.checked=!1),n=function(t){if(t){var n=e.querySelector("[data-action="+t+"]");return n&&n.classList.add("active")}},I.forEach(i,function(e){var t=e.nodeName.toLowerCase(),i=e.style.textAlign;if(i&&("justify"===i&&(i="full"),n("justify"+i[0].toUpperCase()+i.slice(1))),t.match(B)){switch(t){case"a":r.value=e.getAttribute("href"),o.checked="_blank"===e.getAttribute("target"),t="createlink";break;case"img":r.value=e.getAttribute("src"),t="insertimage";break;case"i":t="italic";break;case"u":t="underline";break;case"b":t="bold";break;case"strike":t="strikethrough";break;case"pre":case"code":t="code";break;case"ul":t="insertUnorderedList";break;case"ol":t="insertOrderedList";break;case"li":t="indent"}n(t)}},!0),this},q.prototype.menu=function(){return this._menu?H.isCollapsed?(this._menu.style.display="none",this._inputActive=!1,this):!this._toolbar||this._urlInput&&this._inputActive?void u(this):this:this},q.prototype.refreshMenuPosition=function(){var e=this._range.getBoundingClientRect(),t=e.top-10,n=e.left+e.width/2,i=this._menu,r={x:0,y:0},o=this._stylesheet;if(0===e.width&&0===e.height)return this;if(void 0===this._stylesheet){var a=document.createElement("style");document.head.appendChild(a),this._stylesheet=o=a.sheet}return i.style.display="flex",r.x=n-i.clientWidth/2,r.y=t-i.clientHeight,o.cssRules.length>0&&o.deleteRule(0),r.x<0?(r.x=0,o.insertRule(".pen-menu:after {left: "+n+"px;}",0)):o.insertRule(".pen-menu:after {left: 50%; }",0),r.y<0?(i.classList.add("pen-menu-below"),r.y=e.top+e.height+10):i.classList.remove("pen-menu-below"),i.style.top=r.y+"px",i.style.left=r.x+"px",this},q.prototype.stay=function(e){var t=this;window.onbeforeunload||(window.onbeforeunload=function(){if(!t._isDestroyed)return e.stayMsg})},q.prototype.destroy=function(e){var t=!e,n=e?"setAttribute":"removeAttribute";if(e)v(this),b(this);else{k(this);try{H.removeAllRanges(),this._menu&&this._menu.parentNode.removeChild(this._menu)}catch(e){}}return this._isDestroyed=t,this.config.editor[n]("contenteditable",""),this},q.prototype.rebuild=function(){return this.destroy("it's a joke")},e.Pen=function(e){if(!e)return I.log("can't find config",!0);var t=I.merge(e),n=t.editor.getAttribute("class");return n=n?n.replace(/\bpen\b/g,"")+" pen-textarea "+t.class:"pen pen-textarea",t.editor.setAttribute("class",n),t.editor.innerHTML=t.textarea,t.editor};var G={a:[/<a\b[^>]*href=["']([^"]+|[^']+)\b[^>]*>(.*?)<\/a>/gi,"[$2]($1)"],img:[/<img\b[^>]*src=["']([^\"+|[^']+)[^>]*>/gi,"![]($1)"],b:[/<b\b[^>]*>(.*?)<\/b>/gi,"**$1**"],i:[/<i\b[^>]*>(.*?)<\/i>/gi,"***$1***"],h:[/<h([1-6])\b[^>]*>(.*?)<\/h\1>/gi,function(e,t,n){return"\n"+"######".slice(0,t)+" "+n+"\n"}],li:[/<(li)\b[^>]*>(.*?)<\/\1>/gi,"* $2\n"],blockquote:[/<(blockquote)\b[^>]*>(.*?)<\/\1>/gi,"\n> $2\n"],pre:[/<pre\b[^>]*>(.*?)<\/pre>/gi,"\n```\n$1\n```\n"],code:[/<code\b[^>]*>(.*?)<\/code>/gi,"\n`\n$1\n`\n"],p:[/<p\b[^>]*>(.*?)<\/p>/gi,"\n$1\n"],hr:[/<hr\b[^>]*>/gi,"\n---\n"]};q.prototype.toMd=function(){var e=this.getContent().replace(/\n+/g,"").replace(/<([uo])l\b[^>]*>(.*?)<\/\1l>/gi,"$2");for(var t in G)G.hasOwnProperty(t)&&(e=e.replace.apply(e,G[t]));return e.replace(/\*{5}/g,"**")},t.getSelection&&(H=t.getSelection(),e.Pen=q)}(window,document);