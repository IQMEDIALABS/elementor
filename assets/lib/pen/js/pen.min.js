!function(e,t){function n(e,n,i){var r=" to exec 「"+n+"」 command"+(i?" with value: "+i:"");try{t.execCommand(n,!1,i)}catch(e){return L.log("fail"+r,!0)}L.log("success"+r)}function i(e,t,i){var r=m(e);if(r)return e._range.selectNode(r),e._range.collapse(!1),"insertimage"===t&&e._menu&&k(e._menu,!0),n(e,t,i)}function r(e,t){return-1!==v(e,m(e),!0).indexOf(t)&&(t="p"),n(e,"formatblock",t)}function o(e,t,i){return i="<"+t+">"+(i||E.toString())+"</"+t+">",n(e,"insertHTML",i)}function a(e,t,i){return e.config.linksInNewWindow?(i='< a href="'+i+'" target="_blank">'+E.toString()+"</a>",n(e,"insertHTML",i)):n(e,t,i)}function s(e){var n="",i='<input class="pen-input" placeholder="http://" />';if(e._toolbar=e.config.toolbar,e._toolbar)(e._toolbar.querySelectorAll("[data-action=createlink]").length||e._toolbar.querySelectorAll("[data-action=insertimage]").length)&&(n+=i);else{var r=e.config.list;L.forEach(r,function(t){var i=M[t],r=e.config.titles[t]||"";if(n+='<div class="pen-icon" title="'+r+'" data-action="'+t+'">',i&&i.text)n+=i.text;else{var o;o=i&&i.iconClass?i.class:"fa fa-"+t,n+='<i class="'+o+'"  ></i>'}n+="</div>"},!0),(r.indexOf("createlink")>=0||r.indexOf("insertimage")>=0)&&(n+=i)}n&&(e._menu=t.createElement("div"),e._menu.setAttribute("class",e.config.class+"-menu pen-menu"),e._menu.innerHTML=n,e._inputBar=e._menu.querySelector("input"),k(e._menu,!0),t.body.appendChild(e._menu)),e._toolbar&&e._inputBar&&k(e._inputBar)}function c(n){function i(e){n._range=n.getRange(),a(e)}var r=n._toolbar||n._menu,o=n.config.editor,a=L.delayExec(function(){n.highlight().menu()}),s=function(){};if(n._menu){var c=function(){"flex"===n._menu.style.display&&n.menu()};l(n,e,"resize",c),l(n,e,"scroll",c);var u=!1;l(n,o,"mousedown",function(){u=!0}),l(n,o,"mouseleave",function(){u&&i(800),u=!1}),l(n,o,"mouseup",function(){u&&i(100),u=!1}),s=function(e){!n._menu||g(o,e.target)||g(n._menu,e.target)||(h(n,t,"click",s),a(100))}}else l(n,o,"click",function(){i(0)});l(n,o,"keyup",function(e){if(8===e.which&&n.isEmpty())return y(n,!0);if(13!==e.which||e.shiftKey)return i(400);var r=m(n,!0);r&&r.nextSibling&&S.test(r.nodeName)&&r.nodeName===r.nextSibling.nodeName&&("BR"!==r.lastChild.nodeName&&r.appendChild(t.createElement("br")),L.forEach(r.nextSibling.childNodes,function(e){e&&r.appendChild(e)},!0),r.parentNode.removeChild(r.nextSibling),b(n,r.lastChild,n.getRange()))}),l(n,o,"keydown",function(e){if(o.classList.remove("pen-placeholder"),13===e.which&&!e.shiftKey){var i=m(n,!0);if(i&&S.test(i.nodeName)){var r=i.lastChild;if(r&&r.previousSibling&&!r.previousSibling.textContent&&!r.textContent){e.preventDefault();var a=t.createElement("p");a.innerHTML="<br>",i.removeChild(r),i.nextSibling?i.parentNode.insertBefore(a,i.nextSibling):i.parentNode.appendChild(a),b(n,a,n.getRange())}}}});var f=function(e,t){n.execCommand(e,t),n._range=n.getRange(),n.highlight().menu()};l(n,r,"click",function(e){for(var t,i=e.target;i!==r&&!(t=i.getAttribute("data-action"));)i=i.parentNode;if(t){if(!/(?:createlink)|(?:insertimage)/.test(t))return f(t);if(n._inputBar){var o=n._inputBar;if(r===n._menu?k(o):(n._inputActive=!0,n.menu()),"none"!==n._menu.style.display){setTimeout(function(){o.focus()},400);var a=function(){var e=o.value;e?e=o.value.replace(R.whiteSpace,"").replace(R.mailTo,"mailto:$1").replace(R.http,"http://$1"):t="unlink",f(t,e),r===n._menu?k(o,!1):k(n._menu,!0)};o.onkeypress=function(e){if(13===e.which)return a()}}}}}),l(n,o,"focus",function(){n.isEmpty()&&y(n,!0),l(n,t,"click",s)}),l(n,o,"blur",function(){d(n),n.checkContentChange()}),l(n,o,"paste",function(){setTimeout(function(){n.cleanContent()})})}function l(e,t,n,i){if(e._events.hasOwnProperty(n))e._events[n].push(i);else{e._eventTargets=e._eventTargets||[],e._eventsCache=e._eventsCache||[];var r=e._eventTargets.indexOf(t);r<0&&(r=e._eventTargets.push(t)-1),e._eventsCache[r]=e._eventsCache[r]||{},e._eventsCache[r][n]=e._eventsCache[r][n]||[],e._eventsCache[r][n].push(i),t.addEventListener(n,i,!1)}return e}function u(e,t){if(e._events.hasOwnProperty(t)){var n=A.call(arguments,2);L.forEach(e._events[t],function(t){t.apply(e,n)})}}function h(e,t,n,i){var r=e._events[n];if(!r){var o=e._eventTargets.indexOf(t);o>=0&&(r=e._eventsCache[o][n])}if(!r)return e;var a=r.indexOf(i);return a>=0&&r.splice(a,1),t.removeEventListener(n,i,!1),e}function f(e){return L.forEach(this._events,function(e){e.length=0},!1),e._eventsCache?(L.forEach(e._eventsCache,function(t,n){var i=e._eventTargets[n];L.forEach(t,function(e,t){L.forEach(e,function(e){i.removeEventListener(t,e,!1)},!0)},!1)},!0),e._eventTargets=[],e._eventsCache=[],e):e}function d(e){e.config.editor.classList[e.isEmpty()?"add":"remove"]("pen-placeholder")}function p(e){return(e||"").replace(/^\s+|\s+$/g,"")}function g(e,t){if(e===t)return!0;for(t=t.parentNode;t;){if(t===e)return!0;t=t.parentNode}return!1}function m(e,t){var n,i=e.config.editor;if(e._range=e._range||e.getRange(),!(n=e._range.commonAncestorContainer)||n===i)return null;for(;n&&1!==n.nodeType&&n.parentNode!==i;)n=n.parentNode;for(;n&&t&&n.parentNode!==i;)n=n.parentNode;return g(i,n)?n:null}function v(e,t,n){var i=[];for(t=t||e.config.editor;t&&t!==e.config.editor;)t.nodeName.match($)&&i.push(n?t.nodeName.toLowerCase():t),t=t.parentNode;return i}function y(e,n){var i=e._range=e.getRange(),r=t.createElement("p");n&&(e.config.editor.innerHTML=""),r.innerHTML="<br>",i.insertNode(r),b(e,r.childNodes[0],i)}function b(e,t,n){n.setStartAfter(t),n.setEndBefore(t),n.collapse(!1),e.setRange(n)}function _(e){if(1===e.nodeType){if(q.notLink.test(e.tagName))return;L.forEach(e.childNodes,function(e){_(e)},!0)}else if(3===e.nodeType){var n=C(e.nodeValue||"");if(!n.links)return;var i=t.createDocumentFragment(),r=t.createElement("div");for(r.innerHTML=n.text;r.childNodes.length;)i.appendChild(r.childNodes[0]);e.parentNode.replaceChild(i,e)}}function C(e){var t=0;return e=e.replace(q.url,function(e){var n=e,i=e;return t++,e.length>q.maxLength&&(i=e.slice(0,q.maxLength)+"..."),q.prefix.test(n)||(n="http://"+n),'<a href="'+n+'">'+i+"</a>"}),{links:t,text:e}}function k(e,t){e.style.display=t?"none":"flex"}var x,w,E,L={},N=Object.prototype.toString,A=Array.prototype.slice,T={block:/^(?:p|h[1-6]|blockquote|pre)$/,inline:/^(?:strikethrough|bold|italic|underline|insertorderedlist|insertunorderedlist|indent|outdent)$/,source:/^(?:createlink|unlink)$/,insert:/^(?:inserthorizontalrule|insertimage|insert)$/,wrap:/^(?:code)$/},S=/^(?:blockquote|pre|div)$/i,$=/(?:[pubia]|h[1-6]|blockquote|[uo]l|li)/i,R={whiteSpace:/(^\s+)|(\s+$)/g,mailTo:/^(?!mailto:|.+\/|.+#|.+\?)(.*@.*\..+)$/,http:/^(?!\w+?:\/\/|mailto:|\/|\.\/|\?|#)(.*)$/},q={url:/((https?|ftp):\/\/|www\.)[^\s<]{3,}/gi,prefix:/^(?:https?|ftp):\/\//i,notLink:/^(?:img|a|input|audio|video|source|code|pre|script|head|title|style)$/i,maxLength:100},M={h1:{text:"H1"}};L.is=function(e,t){return N.call(e).slice(8,-1)===t},L.forEach=function(e,t,n){if(e)if(null==n&&(n=L.is(e,"Array")),n)for(var i=0,r=e.length;i<r;i++)t(e[i],i,e);else for(var o in e)e.hasOwnProperty(o)&&t(e[o],o,e)},L.copy=function(e,t){return L.forEach(t,function(t,n){e[n]=L.is(t,"Object")?L.copy({},t):L.is(t,"Array")?L.copy([],t):t}),e},L.log=function(e,t){(w||t)&&console.log("%cPEN DEBUGGER: %c"+e,"font-family:arial,sans-serif;color:#1abf89;line-height:2em;","font-family:cursor,monospace;color:#333;")},L.delayExec=function(e){var t=null;return function(n){clearTimeout(t),t=setTimeout(function(){e()},n||1)}},L.merge=function(e){var n={class:"pen",debug:!1,toolbar:null,stay:e.stay||!e.debug,stayMsg:"Are you going to leave here?",textarea:'<textarea name="content"></textarea>',list:["blockquote","h2","h3","p","code","insertorderedlist","insertunorderedlist","inserthorizontalrule","indent","outdent","bold","italic","underline","createlink","insertimage"],titles:{},cleanAttrs:["id","class","style","name"],cleanTags:["script"],linksInNewWindow:!1};return 1===e.nodeType?n.editor=e:e.match&&e.match(/^#[\S]+$/)?n.editor=t.getElementById(e.slice(1)):n=L.copy(n,e),n},(x=function(e){if(!e)throw new Error("Can't find config");w=e.debug;var t=L.merge(e),n=t.editor;if(!n||1!==n.nodeType)throw new Error("Can't find editor");n.classList.add(t.class),n.setAttribute("contenteditable","true"),this.config=t,t.placeholder&&n.setAttribute("data-placeholder",t.placeholder),d(this),this.selection=E,this._events={change:[]},s(this),c(this),this._prevContent=this.getContent(),this.markdown&&this.markdown.init(this),this.config.stay&&this.stay(this.config),this.config.input&&this.addOnSubmitListener(this.config.input)}).prototype.on=function(e,t){return l(this,this.config.editor,e,t),this},x.prototype.addOnSubmitListener=function(e){var t=this;e.form.addEventListener("submit",function(){e.value=t.config.saveAsMarkdown?t.toMd(t.config.editor.innerHTML):t.config.editor.innerHTML})},x.prototype.isEmpty=function(e){return!((e=e||this.config.editor).querySelector("img")||e.querySelector("blockquote")||e.querySelector("li")||p(e.textContent))},x.prototype.getContent=function(){return this.isEmpty()?"":p(this.config.editor.innerHTML)},x.prototype.setContent=function(e){return this.config.editor.innerHTML=e,this.cleanContent(),this},x.prototype.checkContentChange=function(){var e=this._prevContent,t=this.getContent();e!==t&&(this._prevContent=t,u(this,"change",t,e))},x.prototype.getRange=function(){var e=this.config.editor,n=E.rangeCount&&E.getRangeAt(0);return n||(n=t.createRange()),g(e,n.commonAncestorContainer)||(n.selectNodeContents(e),n.collapse(!1)),n},x.prototype.setRange=function(e){(e=e||this._range)||(e=this.getRange()).collapse(!1);try{E.removeAllRanges(),E.addRange(e)}catch(e){}return this},x.prototype.focus=function(e){return e||this.setRange(),this.config.editor.focus(),this},x.prototype.execCommand=function(e,t){e=e.toLowerCase(),this.setRange(),T.block.test(e)?r(this,e):T.inline.test(e)?n(this,e,t):T.source.test(e)?a(this,e,t):T.insert.test(e)?i(this,e,t):T.wrap.test(e)?o(this,e,t):L.log("can not find command function for name: "+e+(t?", value: "+t:""),!0),"indent"===e?this.checkContentChange():this.cleanContent({cleanAttrs:["style"]})},x.prototype.cleanContent=function(e){var t=this.config.editor;return e||(e=this.config),L.forEach(e.cleanAttrs,function(e){L.forEach(t.querySelectorAll("["+e+"]"),function(t){t.removeAttribute(e)},!0)},!0),L.forEach(e.cleanTags,function(e){L.forEach(t.querySelectorAll(e),function(e){e.parentNode.removeChild(e)},!0)},!0),d(this),this.checkContentChange(),this},x.prototype.autoLink=function(){return _(this.config.editor),this.getContent()},x.prototype.highlight=function(){var e=this._toolbar||this._menu,t=m(this);if(L.forEach(e.querySelectorAll(".active"),function(e){e.classList.remove("active")},!0),!t)return this;var n,i=v(this,t),r=this._inputBar;return r&&e===this._menu&&(r.style.display="none",r.value=""),n=function(t){if(t){var n=e.querySelector("[data-action="+t+"]");return n&&n.classList.add("active")}},L.forEach(i,function(e){var t=e.nodeName.toLowerCase();switch(t){case"a":r&&(r.value=e.getAttribute("href")),t="createlink";break;case"img":r&&(r.value=e.getAttribute("src")),t="insertimage";break;case"i":t="italic";break;case"u":t="underline";break;case"b":t="bold";break;case"strike":t="strikethrough";break;case"pre":case"code":t="code";break;case"ul":t="insertunorderedlist";break;case"ol":t="insertorderedlist";break;case"li":t="indent"}n(t)},!0),this},x.prototype.menu=function(){if(!this._menu)return this;if(E.isCollapsed)return this._menu.style.display="none",this._inputActive=!1,this;if(this._toolbar&&(!this._inputBar||!this._inputActive))return this;var e=this._range.getBoundingClientRect(),t=e.top-10,n=e.left+e.width/2,i=this._menu,r={x:0,y:0},o=this._stylesheet;if(0===e.width&&0===e.height)return this;if(void 0===this._stylesheet){var a=document.createElement("style");document.head.appendChild(a),this._stylesheet=o=a.sheet}return i.style.display="flex",r.x=n-i.clientWidth/2,r.y=t-i.clientHeight,o.cssRules.length>0&&o.deleteRule(0),r.x<0?(r.x=0,o.insertRule(".pen-menu:after {left: "+n+"px;}",0)):o.insertRule(".pen-menu:after {left: 50%; }",0),r.y<0?(i.classList.add("pen-menu-below"),r.y=e.top+e.height+10):i.classList.remove("pen-menu-below"),i.style.top=r.y+"px",i.style.left=r.x+"px",this},x.prototype.stay=function(e){var t=this;window.onbeforeunload||(window.onbeforeunload=function(){if(!t._isDestroyed)return e.stayMsg})},x.prototype.destroy=function(e){var t=!e,n=e?"setAttribute":"removeAttribute";if(e)s(this),c(this);else{f(this);try{E.removeAllRanges(),this._menu&&this._menu.parentNode.removeChild(this._menu)}catch(e){}}return this._isDestroyed=t,this.config.editor[n]("contenteditable",""),this},x.prototype.rebuild=function(){return this.destroy("it's a joke")},e.Pen=function(e){if(!e)return L.log("can't find config",!0);var t=L.merge(e),n=t.editor.getAttribute("class");return n=n?n.replace(/\bpen\b/g,"")+" pen-textarea "+t.class:"pen pen-textarea",t.editor.setAttribute("class",n),t.editor.innerHTML=t.textarea,t.editor};var H={a:[/<a\b[^>]*href=["']([^"]+|[^']+)\b[^>]*>(.*?)<\/a>/gi,"[$2]($1)"],img:[/<img\b[^>]*src=["']([^\"+|[^']+)[^>]*>/gi,"![]($1)"],b:[/<b\b[^>]*>(.*?)<\/b>/gi,"**$1**"],i:[/<i\b[^>]*>(.*?)<\/i>/gi,"***$1***"],h:[/<h([1-6])\b[^>]*>(.*?)<\/h\1>/gi,function(e,t,n){return"\n"+"######".slice(0,t)+" "+n+"\n"}],li:[/<(li)\b[^>]*>(.*?)<\/\1>/gi,"* $2\n"],blockquote:[/<(blockquote)\b[^>]*>(.*?)<\/\1>/gi,"\n> $2\n"],pre:[/<pre\b[^>]*>(.*?)<\/pre>/gi,"\n```\n$1\n```\n"],code:[/<code\b[^>]*>(.*?)<\/code>/gi,"\n`\n$1\n`\n"],p:[/<p\b[^>]*>(.*?)<\/p>/gi,"\n$1\n"],hr:[/<hr\b[^>]*>/gi,"\n---\n"]};x.prototype.toMd=function(){var e=this.getContent().replace(/\n+/g,"").replace(/<([uo])l\b[^>]*>(.*?)<\/\1l>/gi,"$2");for(var t in H)H.hasOwnProperty(t)&&(e=e.replace.apply(e,H[t]));return e.replace(/\*{5}/g,"**")},t.getSelection&&(E=t.getSelection(),e.Pen=x)}(window,document);